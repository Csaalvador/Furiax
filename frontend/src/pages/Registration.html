// FanInsight AI - Página de Registro
// Coleta os dados iniciais do usuário

import { navigateTo } from '../js/routes.js';
import { registerUser } from '../js/api.js';
import { showLoading, hideLoading, showNotification } from '../js/app.js';

export function renderRegistrationPage(container) {
  container.innerHTML = `
    <div class="max-w-2xl mx-auto py-8 px-4">
      <h1 class="text-3xl font-bold mb-8 text-center text-furia-blue">Cadastro FanInsight AI</h1>
      
      <form id="registration-form" class="space-y-6">
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Informações Pessoais</h2>
          
          <div class="space-y-4">
            <div>
              <label for="fullName" class="block text-sm font-medium text-gray-300 mb-1">Nome Completo</label>
              <input type="text" id="fullName" name="fullName" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
            </div>
            
            <div>
              <label for="cpf" class="block text-sm font-medium text-gray-300 mb-1">CPF</label>
              <input type="text" id="cpf" name="cpf" required 
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue"
                placeholder="000.000.000-00">
            </div>
            
            <div>
              <label for="birthDate" class="block text-sm font-medium text-gray-300 mb-1">Data de Nascimento</label>
              <input type="date" id="birthDate" name="birthDate" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
            </div>
            
            <div>
              <label for="email" class="block text-sm font-medium text-gray-300 mb-1">E-mail</label>
              <input type="email" id="email" name="email" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
            </div>
            
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">Telefone</label>
              <input type="tel" id="phone" name="phone" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue"
                placeholder="(00) 00000-0000">
            </div>
          </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Endereço</h2>
          
          <div class="space-y-4">
            <div>
              <label for="zipCode" class="block text-sm font-medium text-gray-300 mb-1">CEP</label>
              <input type="text" id="zipCode" name="zipCode" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue"
                placeholder="00000-000">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="street" class="block text-sm font-medium text-gray-300 mb-1">Rua</label>
                <input type="text" id="street" name="street" required
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
              </div>
              <div>
                <label for="number" class="block text-sm font-medium text-gray-300 mb-1">Número</label>
                <input type="text" id="number" name="number" required
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
              </div>
            </div>
            
            <div>
              <label for="complement" class="block text-sm font-medium text-gray-300 mb-1">Complemento</label>
              <input type="text" id="complement" name="complement"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label for="neighborhood" class="block text-sm font-medium text-gray-300 mb-1">Bairro</label>
                <input type="text" id="neighborhood" name="neighborhood" required
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
              </div>
              <div>
                <label for="city" class="block text-sm font-medium text-gray-300 mb-1">Cidade</label>
                <input type="text" id="city" name="city" required
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
              </div>
              <div>
                <label for="state" class="block text-sm font-medium text-gray-300 mb-1">Estado</label>
                <select id="state" name="state" required
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
                  <option value="">Selecione</option>
                  <option value="AC">AC</option>
                  <option value="AL">AL</option>
                  <option value="AP">AP</option>
                  <option value="AM">AM</option>
                  <option value="BA">BA</option>
                  <option value="CE">CE</option>
                  <option value="DF">DF</option>
                  <option value="ES">ES</option>
                  <option value="GO">GO</option>
                  <option value="MA">MA</option>
                  <option value="MT">MT</option>
                  <option value="MS">MS</option>
                  <option value="MG">MG</option>
                  <option value="PA">PA</option>
                  <option value="PB">PB</option>
                  <option value="PR">PR</option>
                  <option value="PE">PE</option>
                  <option value="PI">PI</option>
                  <option value="RJ">RJ</option>
                  <option value="RN">RN</option>
                  <option value="RS">RS</option>
                  <option value="RO">RO</option>
                  <option value="RR">RR</option>
                  <option value="SC">SC</option>
                  <option value="SP">SP</option>
                  <option value="SE">SE</option>
                  <option value="TO">TO</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Interesses em E-Sports</h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Jogos que você acompanha</label>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="games" value="csgo" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>CS:GO / CS2</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="games" value="valorant" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>Valorant</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="games" value="lol" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>League of Legends</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="games" value="dota2" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>Dota 2</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="games" value="r6" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>Rainbow Six</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="games" value="fifa" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>FIFA / EA FC</span>
                </label>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Times da FURIA que você acompanha</label>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="teams" value="csgo" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>CS:GO / CS2</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="teams" value="valorant" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>Valorant</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="teams" value="female" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>FURIA Feminina</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="teams" value="fifa" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>FIFA / EA FC</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="teams" value="creators" class="rounded text-furia-blue focus:ring-furia-blue">
                  <span>Criadores de Conteúdo</span>
                </label>
              </div>
            </div>
            
            <div>
              <label for="events" class="block text-sm font-medium text-gray-300 mb-1">Eventos da FURIA que você participou nos últimos 12 meses</label>
              <textarea id="events" name="events" rows="3"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue"
                placeholder="Major, RMR, IEM Rio, etc."></textarea>
            </div>
            
            <div>
              <label for="products" class="block text-sm font-medium text-gray-300 mb-1">Produtos da FURIA que você já adquiriu</label>
              <textarea id="products" name="products" rows="3"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue"
                placeholder="Camisetas, moletons, ingressos para eventos, etc."></textarea>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Segurança</h2>
          
          <div class="space-y-4">
            <div>
              <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
              <input type="password" id="password" name="password" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
              <p class="text-xs text-gray-400 mt-1">Mínimo de 8 caracteres, incluindo letras maiúsculas, minúsculas e números</p>
            </div>
            
            <div>
              <label for="confirmPassword" class="block text-sm font-medium text-gray-300 mb-1">Confirme a Senha</label>
              <input type="password" id="confirmPassword" name="confirmPassword" required
                class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-furia-blue">
            </div>
            
            <div class="mt-4">
              <label class="flex items-start space-x-2">
                <input type="checkbox" name="terms" required class="rounded text-furia-blue focus:ring-furia-blue mt-1">
                <span class="text-sm text-gray-300">
                  Concordo com os <a href="#" class="text-furia-blue hover:underline">Termos de Uso</a> e 
                  <a href="#" class="text-furia-blue hover:underline">Política de Privacidade</a> do FanInsight AI
                </span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <button type="button" id="back-btn"
            class="bg-transparent hover:bg-gray-800 text-white border border-gray-600 font-bold py-2 px-6 rounded-lg transition-colors">
            Voltar
          </button>
          
          <button type="submit" id="register-btn"
            class="bg-furia-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
            Continuar para Verificação
          </button>
        </div>
      </form>
    </div>
  `;
  
  // Adicionar eventos aos elementos
  const form = document.getElementById('registration-form');
  const backBtn = document.getElementById('back-btn');
  
  // Máscara para CPF
  const cpfInput = document.getElementById('cpf');
  if (cpfInput) {
    cpfInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      
      if (value.length > 9) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, '$1.$2.$3-$4');
      } else if (value.length > 6) {
        value = value.replace(/^(\d{3})(\d{3})(\d{0,3}).*/, '$1.$2.$3');
      } else if (value.length > 3) {
        value = value.replace(/^(\d{3})(\d{0,3}).*/, '$1.$2');
      }
      
      e.target.value = value;
    });
  }
  
  // Máscara para CEP
  const zipCodeInput = document.getElementById('zipCode');
  if (zipCodeInput) {
    zipCodeInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 8) value = value.slice(0, 8);
      
      if (value.length > 5) {
        value = value.replace(/^(\d{5})(\d{0,3}).*/, '$1-$2');
      }
      
      e.target.value = value;
    });
    
    // Autocomplete de endereço pelo CEP
    zipCodeInput.addEventListener('blur', async function() {
      const cep = this.value.replace(/\D/g, '');
      if (cep.length === 8) {
        try {
          const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await response.json();
          
          if (!data.erro) {
            document.getElementById('street').value = data.logradouro;
            document.getElementById('neighborhood').value = data.bairro;
            document.getElementById('city').value = data.localidade;
            document.getElementById('state').value = data.uf;
          }
        } catch (error) {
          console.error('Erro ao buscar CEP:', error);
        }
      }
    });
  }
  
  // Máscara para telefone
  const phoneInput = document.getElementById('phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      
      if (value.length > 10) {
        value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
      } else if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
      } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
      }
      
      e.target.value = value;
    });
  }
  
  // Validação de senha
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  
  if (confirmPasswordInput) {
    confirmPasswordInput.addEventListener('input', function() {
      if (passwordInput.value !== confirmPasswordInput.value) {
        confirmPasswordInput.setCustomValidity('As senhas não coincidem');
      } else {
        confirmPasswordInput.setCustomValidity('');
      }
    });
  }
  
  // Botão voltar
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      navigateTo('/');
    });
  }
  
  // Submissão do formulário
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validar formulário 
      if (!form.checkValidity()) {
        showNotification('Por favor, preencha todos os campos obrigatórios corretamente.', 'error');
        return;
      }
      
      // Coletar os dados do formulário
      const formData = new FormData(form);
      const userData = {
        personalInfo: {
          fullName: formData.get('fullName'),
          cpf: formData.get('cpf'),
          birthDate: formData.get('birthDate'),
          email: formData.get('email'),
          phone: formData.get('phone')
        },
        address: {
          zipCode: formData.get('zipCode'),
          street: formData.get('street'),
          number: formData.get('number'),
          complement: formData.get('complement'),
          neighborhood: formData.get('neighborhood'),
          city: formData.get('city'),
          state: formData.get('state')
        },
        interests: {
          games: Array.from(formData.getAll('games')),
          teams: Array.from(formData.getAll('teams')),
          events: formData.get('events'),
          products: formData.get('products')
        },
        password: formData.get('password')
      };
      
      // Enviar os dados para o servidor
      showLoading();
      try {
        await registerUser(userData);
        showNotification('Cadastro realizado com sucesso!', 'success');
        navigateTo('/verification');
      } catch (error) {
        showNotification('Erro ao realizar cadastro. Tente novamente.', 'error');
        console.error('Erro de registro:', error);
      } finally {
        hideLoading();
      }
    });
  }
}